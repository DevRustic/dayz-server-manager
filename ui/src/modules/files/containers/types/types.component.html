<sb-layout-dashboard class="types-component">
    <sb-dashboard-head title="Files" [hideBreadcrumbs]="false"></sb-dashboard-head>
    <sb-card background="h-100 type-tabs">
        <div class="card-header" style="display: flex; align-items: center; padding-bottom: 0.5rem; padding-top: 0.5rem;">
            <div class="mr-3" title="Un/Lock the width of the table columns">
                <fa-icon class="mr-1" [icon]='["fas", lockedWidth ? "lock" : "lock-open"]'></fa-icon>
                <input type="checkbox" [(ngModel)]="lockedWidth">
            </div>

            <div ngbDropdown>
                <button type="button"
                        class="btn btn-outline-primary"
                        id="dropdownFiles" ngbDropdownToggle
                        style="padding: 0.25rem;"
                >
                    <fa-icon class="mr-1" [icon]='["fas", "wrench"]'></fa-icon>
                    Type Files
                </button>
                <div ngbDropdownMenu aria-labelledby="dropdownFiles">
                    <button ngbDropdownItem
                            *ngFor="let file of files; let i = index;"
                            (click)="activeTab = i"
                    >
                        {{ file.file }}
                    </button>
                </div>
            </div>

            <ul style="display: none;" class="nav-tabs" [(activeId)]="activeTab" ngbNav #nav="ngbNav">
                <li *ngFor="let file of files; let i = index;" [ngbNavItem]="i">
                    <a ngbNavLink>{{ file.file }}</a>
                    <ng-template ngbNavContent>
                        <div style="height: 100%; margin-bottom: 20px;">
                            <ag-grid-angular
                                [columnDefs]="typesColumnDefs"
                                [defaultColDef]="defaultColDef"
                                [rowData]="file.content.types.type"
                                [getRowStyle]="getRowStyle"
                                [floatingFiltersHeight]="50"
                                [groupHeaderHeight]="75"
                                (rowDataUpdated)="filterChanged()"
                                (firstDataRendered)="filterChanged()"
                                (filterChanged)="filterChanged()"
                                style="width: 100%; height: 100%;"
                                class="ag-theme-alpine"
                                #dataGrid
                            >
                            </ag-grid-angular>

                        </div>
                    </ng-template>
                </li>
            </ul>

            <div class="d-flex ml-auto">
                <fa-icon class="mr-2" [icon]='["fas", "info"]'></fa-icon>
                <div class="mr-2">Shown: {{ shownTypesCount }}</div>
                <div>Total Nominal: {{ totalNominal }}</div>
            </div>
        </div>
        <div class="card-body" *ngIf="!loading">
            <div class="d-flex flex-row justify-content-between">
                <ngb-alert  *ngIf="outcomeBadge"
                            [type]="outcomeBadge.success ? 'success' : 'danger'"
                >
                    {{ outcomeBadge.message }}
                </ngb-alert>
                <ngb-alert  *ngIf="validationErrors?.length"
                            type="danger"
                >
                    <div>
                        Errors:
                        <ul style="max-height: 10vh; overflow-y: scroll;">
                            <li *ngFor="let error of validationErrors">
                                {{ error }}
                            </li>
                        </ul>
                    </div>
                </ngb-alert>
            </div>
            <form (ngSubmit)="onSubmit()" #configForm="ngForm">

                <div [ngbNavOutlet]="nav"></div>

                <div class="d-flex flex-row" style="justify-content: space-between; flex-wrap: wrap; white-space: nowrap;">
                    <div class="d-flex flex-row">
                        <div class="d-flex flex-row btn-group ml-1 mr-1">
                            <input #changeInput style="margin-right: -2px;">
                            <select #attrChangeInput>
                                <option *ngFor="let item of attrs; let idx = index"
                                        [ngValue]="item.value"
                                        [value]="item.value"
                                        [selected]="idx === 0"
                                >
                                    {{ item.label }}
                                </option>
                            </select>
                            <select #attrChangeOperation>
                                <option value="multiply" selected title="Multiply by factor">Multiply</option>
                                <option value="multiply-percent" title="Multiply by percent">Multiply %</option>
                                <option value="set" title="Set to a fixed value">Set</option>
                                <option value="add" title="Add a fixed value or add it to the list">Add</option>
                                <option value="remove" title="Remove a fixed value or remove it from the list">Remove</option>
                            </select>
                            <button type="button" class="btn btn-success"
                                    (click)="changeAttr(attrChangeOperation.value, attrChangeInput.value, changeInput.value)"
                                    title="Execute the operation"
                            >
                                Exec
                            </button>
                        </div>
                    </div>
                    <div class="d-flex flex-row">
                        <button type="button" class="btn btn-success ml-1 mr-1"
                                (click)="validate(true)"
                        >
                            Validate
                        </button>
                        <button type="button" class="btn btn-success ml-1 mr-1"
                                [disabled]="!configForm.form.valid"
                                (click)="saveCurrentFile()"
                        >
                            Download
                        </button>
                    </div>
                    <div class="d-flex flex-row">
                        <div class="d-flex flex-row ml-1 mr-1" style="align-items: center;">
                            <label class="form-label" style="white-space: nowrap;">Create Backup</label>
                            <input type="checkbox" class="form-control form-control-sm mx-1"
                                   [(ngModel)]="withBackup"
                                   [ngModelOptions]="{standalone: true}"
                                   [disabled]="submitting"
                            >
                        </div>
                        <div class="d-flex flex-row ml-1 mr-1" style="align-items: center;">
                            <label class="form-label" style="white-space: nowrap;">Restart Server</label>
                            <input type="checkbox" class="form-control form-control-sm mx-1"
                                   [(ngModel)]="withRestart"
                                   [ngModelOptions]="{standalone: true}"
                                   [disabled]="submitting"
                            >
                        </div>
                        <button type="submit" class="btn btn-success ml-1 mr-1"
                                [disabled]="!configForm.form.valid || submitting"
                        >
                            <fa-icon *ngIf="submitting" [icon]='["fas", "spinner"]' [classes]="['fa-spin']"></fa-icon>
                            Submit
                        </button>
                        <button type="button" class="btn btn-primary ml-1 mr-1"
                                (click)="resetClicked()"
                                [disabled]="submitting"
                        >
                            Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <div class="card-body" *ngIf="loading">
            <fa-icon [icon]='["fas", "spinner"]' [classes]="['fa-spin']"></fa-icon>
        </div>
    </sb-card>
</sb-layout-dashboard>
